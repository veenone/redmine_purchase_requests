<%# app/views/settings/_purchase_request_currency.html.erb %>
<h3><%= l(:label_currency_settings) %></h3>

<p>
  <label><%= l(:label_default_currency) %></label>
  <% 
    currency_options = [
      ['US Dollar ($)', 'USD'],
      ['Euro (€)', 'EUR'],
      ['British Pound (£)', 'GBP'],
      ['Japanese Yen (¥)', 'JPY'],
      ['Canadian Dollar (C$)', 'CAD'],
      ['Australian Dollar (A$)', 'AUD'],
      ['Swiss Franc (CHF)', 'CHF'],
      ['Chinese Yuan (¥)', 'CNY'],
      ['Swedish Krona (kr)', 'SEK'],
      ['New Zealand Dollar (NZ$)', 'NZD'],
      ['Mexican Peso (Mex$)', 'MXN'],
      ['Singapore Dollar (S$)', 'SGD'],
      ['Hong Kong Dollar (HK$)', 'HKD'],
      ['Indonesian Rupiah (Rp)', 'IDR'],
      ['Norwegian Krone (kr)', 'NOK'],
      ['South Korean Won (₩)', 'KRW'],
      ['Turkish Lira (₺)', 'TRY'],
      ['Russian Ruble (₽)', 'RUB'],
      ['Indian Rupee (₹)', 'INR'],
      ['Brazilian Real (R$)', 'BRL'],
      ['South African Rand (R)', 'ZAR']
    ]
    # Ensure the current setting is a string to avoid comparison issues
    current_currency = @settings['default_currency'].to_s || 'USD'
  %>
  <%= select_tag 'settings[default_currency]',
                options_for_select(currency_options, current_currency),
                class: 'currency-select' %>
</p>

<p>
  <label><%= l(:label_enabled_currencies) %></label>
  <div class="enabled-currencies-container">
    <% all_currencies = [
      ['US Dollar ($)', 'USD'],
      ['Euro (€)', 'EUR'],
      ['British Pound (£)', 'GBP'],
      ['Japanese Yen (¥)', 'JPY'],
      ['Canadian Dollar (C$)', 'CAD'],
      ['Australian Dollar (A$)', 'AUD'],
      ['Swiss Franc (CHF)', 'CHF'],
      ['Chinese Yuan (¥)', 'CNY'],
      ['Swedish Krona (kr)', 'SEK'],
      ['New Zealand Dollar (NZ$)', 'NZD'],
      ['Mexican Peso (Mex$)', 'MXN'],
      ['Singapore Dollar (S$)', 'SGD'],
      ['Hong Kong Dollar (HK$)', 'HKD'],
      ['Indonesian Rupiah (Rp)', 'IDR'],
      ['Norwegian Krone (kr)', 'NOK'],
      ['South Korean Won (₩)', 'KRW'],
      ['Turkish Lira (₺)', 'TRY'],
      ['Russian Ruble (₽)', 'RUB'],
      ['Indian Rupee (₹)', 'INR'],
      ['Brazilian Real (R$)', 'BRL'],
      ['South African Rand (R)', 'ZAR']
    ] %>
    
    <% enabled_currencies = @settings['enabled_currencies'].is_a?(Array) ? @settings['enabled_currencies'] : (@settings['enabled_currencies'] ? @settings['enabled_currencies'].split(',') : ['USD']) %>
    
    <table class="list">
      <thead>
        <tr>
          <th style="width: 30px;"></th>
          <th><%= l(:field_currency) %></th>
          <th><%= l(:field_code) %></th>
        </tr>
      </thead>
      <tbody>
        <% all_currencies.each do |currency_name, currency_code| %>
          <tr>
            <td>
              <%= check_box_tag "settings[enabled_currencies][]", currency_code, 
                              enabled_currencies.include?(currency_code),
                              id: "currency_#{currency_code}" %>
            </td>
            <td><label for="currency_<%= currency_code %>"><%= currency_name %></label></td>
            <td><%= currency_code %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <%= hidden_field_tag "settings[enabled_currencies][]", "" %>
  </div>
</p>

<p>
  <label><%= l(:label_show_exchange_rates) %></label>
  <%= check_box_tag 'settings[show_exchange_rates]', '1', @settings['show_exchange_rates'] == '1' %>
  <em class="info"><%= l(:text_show_exchange_rates_info) %></em>
</p>

<fieldset class="box">
  <legend><%= l(:label_exchange_rates) %></legend>
  <div class="exchange-rates-container">
    <p class="info-text"><%= l(:text_exchange_rates_setup_info) %></p>
    
    <% 
      default_currency = @settings['default_currency'] || 'USD'
      exchange_rates = @settings['exchange_rates'].is_a?(Hash) ? @settings['exchange_rates'] : {}
      enabled_currencies = @settings['enabled_currencies'].is_a?(Array) ? @settings['enabled_currencies'] : (@settings['enabled_currencies'] ? @settings['enabled_currencies'].split(',') : ['USD'])
    %>
    
    <table class="list">
      <thead>
        <tr>
          <th><%= l(:field_currency) %></th>
          <th><%= l(:label_rate_to) %> <%= default_currency %></th>
          <th><%= l(:field_description) %></th>
        </tr>
      </thead>
      <tbody>
        <% enabled_currencies.each do |currency| %>
          <% next if currency == default_currency %>
          <tr>
            <td><%= currency %></td>
            <td>
              <%# Instead of using nested parameters, use a single flat parameter name %>
              <%= text_field_tag "settings[exchange_rate_#{currency}]", 
                             exchange_rates[currency].to_s, 
                             size: 10, 
                             class: 'exchange-rate',
                             placeholder: '1.0' %>
            </td>
            <td>
              <em class="info exchange-rate-example">
                <%= l(:text_exchange_rate_example, 
                    amount: '100', 
                    currency: currency, 
                    converted: (100.0 / exchange_rates[currency].to_f rescue 100.0).round(2), 
                    default_currency: default_currency) %>
              </em>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <p class="note"><%= l(:text_exchange_rates_note) %></p>
  </div>
</fieldset>

<style>
  .enabled-currencies-container {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 3px;
    margin-top: 5px;
    background-color: #f9f9f9;
    padding-right: 15px;
  }
  
  .currency-checkbox {
    margin-bottom: 8px;
    padding: 5px;
    border-bottom: 1px dotted #eee;
    display: flex;
    align-items: center;
  }
  
  .currency-checkbox:last-child {
    border-bottom: none;
  }
  
  .currency-checkbox label {
    display: flex;
    align-items: center;
    width: 100%;
    cursor: pointer;
    font-weight: normal;
    margin: 0;
  }
  
  .currency-checkbox input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
    opacity: 1 !important;
    position: static !important;
    width: auto !important;
    height: auto !important;
    display: inline-block !important;
    visibility: visible !important;
    appearance: auto !important;
    -webkit-appearance: checkbox !important;
    -moz-appearance: checkbox !important;
  }
  
  .currency-select {
    min-width: 200px;
    padding: 4px;
    border-radius: 3px;
    border: 1px solid #ccc;
  }
  
  /* Better label spacing */
  .enabled-currencies-container label {
    margin-bottom: 3px;
    font-weight: normal;
    display: flex !important;
    align-items: center;
  }
  
  /* Adding visual cues */
  .currency-checkbox:hover {
    background-color: #e9e9e9;
  }
</style>

<%= javascript_tag do %>
  $(document).ready(function() {
    // Make the default currency always checked
    $('#settings_default_currency').on('change', function() {
      var selectedCurrency = $(this).val();
      $('#currency_' + selectedCurrency).prop('checked', true);
    });
    
    // Ensure at least one currency is selected
    $('form').on('submit', function() {
      if ($('input[name="settings[enabled_currencies][]"]:checked').length === 0) {
        alert('<%= l(:error_at_least_one_currency) %>');
        return false;
      }
      return true;
    });
    
    // Initially make sure default currency is checked
    var defaultCurrency = $('#settings_default_currency').val();
    $('#currency_' + defaultCurrency).prop('checked', true);
    
    // Highlight rows on hover
    $('.currency-checkbox').hover(
      function() { $(this).css('background-color', '#e9e9e9'); },
      function() { $(this).css('background-color', 'transparent'); }
    );
  });
<% end %>