<h3><%= l(:label_currency_settings) %></h3>

<p>
  <label><%= l(:label_default_currency) %></label>
  <%= select_tag 'settings[default_currency]',
                options_for_select([
                  ['US Dollar ($)', 'USD'],
                  ['Euro (€)', 'EUR'],
                  ['British Pound (£)', 'GBP'],
                  ['Japanese Yen (¥)', 'JPY'],
                  ['Canadian Dollar (C$)', 'CAD'],
                  ['Australian Dollar (A$)', 'AUD'],
                  ['Swiss Franc (CHF)', 'CHF'],
                  ['Chinese Yuan (¥)', 'CNY'],
                  ['Swedish Krona (kr)', 'SEK'],
                  ['New Zealand Dollar (NZ$)', 'NZD'],
                  ['Mexican Peso (Mex$)', 'MXN'],
                  ['Singapore Dollar (S$)', 'SGD'],
                  ['Hong Kong Dollar (HK$)', 'HKD'],
                  ['Indonesian Rupiah (Rp)', 'IDR'],
                  ['Norwegian Krone (kr)', 'NOK'],
                  ['South Korean Won (₩)', 'KRW'],
                  ['Turkish Lira (₺)', 'TRY'],
                  ['Russian Ruble (₽)', 'RUB'],
                  ['Indian Rupee (₹)', 'INR'],
                  ['Brazilian Real (R$)', 'BRL'],
                  ['South African Rand (R)', 'ZAR']
                ], @settings['default_currency'] || 'USD'),
                class: 'currency-select' %>
</p>

<p>
  <label><%= l(:label_enabled_currencies) %></label>
  <div class="enabled-currencies-container">
    <% all_currencies = [
      ['US Dollar ($)', 'USD'],
      ['Euro (€)', 'EUR'],
      ['British Pound (£)', 'GBP'],
      ['Japanese Yen (¥)', 'JPY'],
      ['Canadian Dollar (C$)', 'CAD'],
      ['Australian Dollar (A$)', 'AUD'],
      ['Swiss Franc (CHF)', 'CHF'],
      ['Chinese Yuan (¥)', 'CNY'],
      ['Swedish Krona (kr)', 'SEK'],
      ['New Zealand Dollar (NZ$)', 'NZD'],
      ['Mexican Peso (Mex$)', 'MXN'],
      ['Singapore Dollar (S$)', 'SGD'],
      ['Hong Kong Dollar (HK$)', 'HKD'],
      ['Indonesian Rupiah (Rp)', 'IDR'],
      ['Norwegian Krone (kr)', 'NOK'],
      ['South Korean Won (₩)', 'KRW'],
      ['Turkish Lira (₺)', 'TRY'],
      ['Russian Ruble (₽)', 'RUB'],
      ['Indian Rupee (₹)', 'INR'],
      ['Brazilian Real (R$)', 'BRL'],
      ['South African Rand (R)', 'ZAR']
    ] %>
    
    <% enabled_currencies = @settings['enabled_currencies'].is_a?(Array) ? @settings['enabled_currencies'] : (@settings['enabled_currencies'] ? @settings['enabled_currencies'].split(',') : ['USD']) %>
    
    <table class="list">
      <thead>
        <tr>
          <th style="width: 30px;"></th>
          <th><%= l(:field_currency) %></th>
          <th><%= l(:field_code) %></th>
        </tr>
      </thead>
      <tbody>
        <% all_currencies.each do |currency_name, currency_code| %>
          <tr>
            <td>
              <%= check_box_tag "settings[enabled_currencies][]", currency_code, 
                              enabled_currencies.include?(currency_code),
                              id: "currency_#{currency_code}" %>
            </td>
            <td><label for="currency_<%= currency_code %>"><%= currency_name %></label></td>
            <td><%= currency_code %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <%= hidden_field_tag "settings[enabled_currencies][]", "" %>
  </div>
</p>

<p>
  <label><%= l(:label_show_exchange_rates) %></label>
  <%= check_box_tag 'settings[show_exchange_rates]', '1', @settings['show_exchange_rates'] == '1' %>
  <em class="info"><%= l(:text_show_exchange_rates_info) %></em>
</p>

<div class="box tabular settings">
  <p>
    <label for="settings_default_currency"><%= l(:setting_default_currency) %></label>
    <%= select_tag 'settings[default_currency]',
                   options_for_select(available_currencies, @settings['default_currency']),
                   include_blank: false %>
    <em class="info"><%= l(:text_default_currency_info) %></em>
  </p>
  
  <p>
    <label for="settings_enabled_currencies"><%= l(:setting_enabled_currencies) %></label>
    <%= select_tag 'settings[enabled_currencies][]',
                 options_for_select(available_currencies, @settings['enabled_currencies']),
                 multiple: true, size: 8 %>
    <em class="info"><%= l(:text_enabled_currencies_info) %></em>
  </p>
  
  <fieldset class="box">
    <legend><%= l(:label_exchange_rates) %></legend>
    <div class="exchange-rates-container">
      <p class="info-text"><%= l(:text_exchange_rates_setup_info) %></p>
      
      <% 
        default_currency = @settings['default_currency'] || 'USD'
        exchange_rates = @settings['exchange_rates'] || {}
        enabled_currencies = @settings['enabled_currencies'] || []
      %>
      
      <table class="list">
        <thead>
          <tr>
            <th><%= l(:field_currency) %></th>
            <th><%= l(:label_rate_to) %> <%= default_currency %></th>
            <th><%= l(:field_description) %></th>
          </tr>
        </thead>
        <tbody>
          <% enabled_currencies.each do |currency| %>
            <% next if currency == default_currency %>
            <tr>
              <td><%= currency %></td>
              <td>
                <%= text_field_tag "settings[exchange_rates][#{currency}]", 
                                 exchange_rates[currency], 
                                 size: 10,
                                 class: 'exchange-rate',
                                 placeholder: '1.0' %>
              </td>
              <td>
                <em class="info exchange-rate-example">
                  <%= l(:text_exchange_rate_example, 
                      amount: '100', 
                      currency: currency, 
                      converted: (100.0 / exchange_rates[currency].to_f).round(2), 
                      default_currency: default_currency) %>
                </em>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
      <p class="note"><%= l(:text_exchange_rates_note) %></p>
    </div>
  </fieldset>
</div>

<style>
  .enabled-currencies-container {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 3px;
    margin-top: 5px;
    background-color: #f9f9f9;
    padding-right: 15px;
  }
  
  .currency-checkbox {
    margin-bottom: 8px;
    padding: 5px;
    border-bottom: 1px dotted #eee;
    display: flex;
    align-items: center;
  }
  
  .currency-checkbox:last-child {
    border-bottom: none;
  }
  
  .currency-checkbox label {
    display: flex;
    align-items: center;
    width: 100%;
    cursor: pointer;
    font-weight: normal;
    margin: 0;
  }
  
  .currency-checkbox input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
    opacity: 1 !important;
    position: static !important;
    width: auto !important;
    height: auto !important;
    display: inline-block !important;
    visibility: visible !important;
    appearance: auto !important;
    -webkit-appearance: checkbox !important;
    -moz-appearance: checkbox !important;
  }
  
  .currency-select {
    min-width: 200px;
    padding: 4px;
    border-radius: 3px;
    border: 1px solid #ccc;
  }
  
  /* Better label spacing */
  .enabled-currencies-container label {
    margin-bottom: 3px;
    font-weight: normal;
    display: flex !important;
    align-items: center;
  }
  
  /* Adding visual cues */
  .currency-checkbox:hover {
    background-color: #e9e9e9;
  }
</style>

<%= javascript_tag do %>
  $(document).ready(function() {
    // Make the default currency always checked
    $('#settings_default_currency').on('change', function() {
      var selectedCurrency = $(this).val();
      $('#currency_' + selectedCurrency).prop('checked', true);
    });
    
    // Ensure at least one currency is selected
    $('form').on('submit', function() {
      if ($('input[name="settings[enabled_currencies][]"]:checked').length === 0) {
        alert('<%= l(:error_at_least_one_currency) %>');
        return false;
      }
      return true;
    });
    
    // Initially make sure default currency is checked
    var defaultCurrency = $('#settings_default_currency').val();
    $('#currency_' + defaultCurrency).prop('checked', true);
    
    // Highlight rows on hover
    $('.currency-checkbox').hover(
      function() { $(this).css('background-color', '#e9e9e9'); },
      function() { $(this).css('background-color', 'transparent'); }
    );
  });
<% end %>

<script>
  $(document).ready(function() {
    // Update exchange rate examples when the rate input changes
    $('.exchange-rate').on('input', function() {
      var $row = $(this).closest('tr');
      var currency = $row.find('td:first').text();
      var rate = parseFloat($(this).val()) || 1.0;
      var defaultCurrency = '<%= @settings['default_currency'] || 'USD' %>';
      var amount = 100;
      var converted = (amount / rate).toFixed(2);
      
      var exampleText = '<%= l(:text_exchange_rate_example, 
                             amount: '100', 
                             currency: 'XXX', 
                             converted: '0.00', 
                             default_currency: @settings['default_currency'] || 'USD') %>';
                             
      exampleText = exampleText.replace('100 XXX', '100 ' + currency);
      exampleText = exampleText.replace('0.00', converted);
      
      $row.find('.exchange-rate-example').text(exampleText);
    });
    
    // When default currency changes, reload the page to update exchange rate table
    $('#settings_default_currency').change(function() {
      // Submit the form when default currency changes
      $(this).closest('form').submit();
    });
  });
</script>